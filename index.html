<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Sentiment Analysis Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Segoe UI", sans-serif;
        background: #ffeef4;
        padding: 40px;
        margin: 0;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      h2 {
        color: #c2185b;
        margin-bottom: 20px;
        text-align: center;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
        margin-bottom: 40px;
      }

      .analysis-section {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      textarea {
        width: 100%;
        padding: 15px;
        font-size: 16px;
        border: 2px solid #f48fb1;
        border-radius: 8px;
        resize: vertical;
        background: #fff0f6;
        box-sizing: border-box;
        min-height: 120px;
      }

      .button-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      button {
        padding: 12px 24px;
        font-size: 16px;
        background: #ec407a;
        border: none;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        flex: 1;
      }

      button:hover {
        background: #c2185b;
        transform: translateY(-2px);
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
      }

      .result-box {
        margin-top: 20px;
      }

      .sentiment {
        font-size: 1.4rem;
        font-weight: bold;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .positive {
        color: #2e7d32;
      }

      .negative {
        color: #ff0000;
      }

      .neutral {
        color: #6c757d;
      }

      .mixed {
        color: #ef6c00;
      }

      .language-info {
        background: #e3f2fd;
        padding: 10px 15px;
        border-radius: 8px;
        margin: 15px 0;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .score-details {
        background: #ffffff;
        padding: 15px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        margin-top: 15px;
      }

      .score-bar {
        display: flex;
        align-items: center;
        margin: 10px 0;
      }

      .score-label {
        width: 80px;
        font-weight: bold;
        font-size: 14px;
      }

      .score-progress {
        flex: 1;
        height: 20px;
        background: #f0f0f0;
        border-radius: 10px;
        overflow: hidden;
        margin: 0 10px;
      }

      .score-fill {
        height: 100%;
        transition: width 0.5s ease;
      }

      .score-value {
        width: 50px;
        text-align: right;
        font-size: 14px;
      }

      #chartContainer {
        width: 100%;
        max-width: 350px;
        margin: 20px auto;
      }

      .history-section {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        max-height: 600px;
        overflow-y: auto;
      }

      .history-title {
        font-size: 1.3rem;
        color: #880e4f;
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .clear-history {
        padding: 6px 12px;
        font-size: 14px;
        background: #f48fb1;
      }

      .history-item {
        background: #fce4ec;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        border-left: 4px solid #ec407a;
        cursor: pointer;
        transition: all 0.3s;
      }

      .history-item:hover {
        transform: translateX(5px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .history-text {
        font-size: 14px;
        color: #333;
        margin-bottom: 8px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .history-meta {
        display: flex;
        gap: 15px;
        font-size: 12px;
        color: #666;
        flex-wrap: wrap;
      }

      .history-meta span {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .empty-history {
        text-align: center;
        color: #999;
        padding: 40px 20px;
        font-style: italic;
      }

      @media (max-width: 968px) {
        .main-content {
          grid-template-columns: 1fr;
        }

        .history-section {
          max-height: 400px;
        }
      }

      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #ec407a;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2>üíñ Sentiment Analysis (AWS Comprehend)</h2>

      <div class="main-content">
        <div class="analysis-section">
          <textarea
            id="comment"
            rows="5"
            placeholder="Enter your comment in any language..."
          ></textarea>

          <div class="button-group">
            <button onclick="analyze()" id="analyzeBtn">
              üîç Analysis
            </button>
            <button onclick="speakComment()" id="speakBtn" disabled>
              üîä Speak Comment
            </button>
          </div>

          <div id="resultBox" class="result-box"></div>
          <div id="chartContainer">
            <canvas id="sentimentChart"></canvas>
          </div>
        </div>

        <div class="history-section">
          <div class="history-title">
            üìú Analysis History
            <button class="clear-history" onclick="clearHistory()">Clear</button>
          </div>
          <div id="historyList"></div>
        </div>
      </div>
    </div>

    <script>
      let chartInstance = null;
      let currentResult = null;
      let historyData = [];

      // Load history from memory on page load
      window.addEventListener('DOMContentLoaded', () => {
        renderHistory();
      });

      async function analyze() {
        const text = document.getElementById("comment").value.trim();
        if (!text) {
          alert("Please enter your comment!");
          return;
        }

        const analyzeBtn = document.getElementById("analyzeBtn");
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<span class="loading"></span> Analyzing...';

        try {
          const res = await fetch("/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ text }),
          });

          const data = await res.json();
          const sentiment = data.Sentiment;
          const score = data.SentimentScore;
          
          // Detect language from text
          const language = detectLanguage(text);
          const confidence = 0.95;

          currentResult = { sentiment, score, language, text };

          const icons = {
            POSITIVE: "üòä",
            NEGATIVE: "üòû",
            NEUTRAL: "üòê",
            MIXED: "ü§î",
          };

          const classes = {
            POSITIVE: "positive",
            NEGATIVE: "negative",
            NEUTRAL: "neutral",
            MIXED: "mixed",
          };

          const languageNames = {
            en: "English",
            vi: "Vietnamese",
            es: "Spanish",
            fr: "French",
            de: "German",
            ja: "Japanese",
            zh: "Chinese",
            ko: "Korean",
          };

          // Display result
          document.getElementById("resultBox").innerHTML = `
            <div class="language-info">
              üåç <strong>Language:</strong> ${languageNames[language] || language.toUpperCase()} 
              (${(confidence * 100).toFixed(1)}% confidence)
            </div>
            <div class="sentiment ${classes[sentiment]}">
              ${icons[sentiment]} ${sentiment}
            </div>
            <div class="score-details">
              <div class="score-bar">
                <div class="score-label positive">Positive</div>
                <div class="score-progress">
                  <div class="score-fill" style="width: ${score.Positive * 100}%; background: #4caf50;"></div>
                </div>
                <div class="score-value">${(score.Positive * 100).toFixed(1)}%</div>
              </div>
              <div class="score-bar">
                <div class="score-label negative">Negative</div>
                <div class="score-progress">
                  <div class="score-fill" style="width: ${score.Negative * 100}%; background: #ff0000;"></div>
                </div>
                <div class="score-value">${(score.Negative * 100).toFixed(1)}%</div>
              </div>
              <div class="score-bar">
                <div class="score-label neutral">Neutral</div>
                <div class="score-progress">
                  <div class="score-fill" style="width: ${score.Neutral * 100}%; background: #ffeb3b;"></div>
                </div>
                <div class="score-value">${(score.Neutral * 100).toFixed(1)}%</div>
              </div>
              <div class="score-bar">
                <div class="score-label mixed">Mixed</div>
                <div class="score-progress">
                  <div class="score-fill" style="width: ${score.Mixed * 100}%; background: #ff9800;"></div>
                </div>
                <div class="score-value">${(score.Mixed * 100).toFixed(1)}%</div>
              </div>
            </div>
          `;

          // Chart data
          const chartData = {
            labels: ["Positive", "Negative", "Neutral", "Mixed"],
            datasets: [
              {
                label: "Sentiment Score",
                data: [
                  score.Positive * 100,
                  score.Negative * 100,
                  score.Neutral * 100,
                  score.Mixed * 100,
                ],
                backgroundColor: ["#4caf50", "#ff0000", "#ffeb3b", "#ff9800"],
                hoverOffset: 8,
              },
            ],
          };

          if (chartInstance) chartInstance.destroy();

          const ctx = document.getElementById("sentimentChart").getContext("2d");
          chartInstance = new Chart(ctx, {
            type: "doughnut",
            data: chartData,
            options: {
              plugins: {
                legend: {
                  position: "bottom",
                  labels: { color: "#444" },
                },
              },
            },
          });

          // Add to history
          addToHistory({
            text,
            sentiment,
            score,
            language,
            timestamp: new Date().toISOString(),
          });

          // Enable speak button
          document.getElementById("speakBtn").disabled = false;

        } catch (error) {
          alert("Error analyzing sentiment: " + error.message);
        } finally {
          analyzeBtn.disabled = false;
          analyzeBtn.innerHTML = 'üîç Analysis';
        }
      }

      function speakComment() {
        if (!currentResult) return;

        const text = document.getElementById("comment").value.trim();
        if (!text) return;

        const { language } = currentResult;
        
        // Language code mapping for speech synthesis
        const voiceMap = {
          vi: 'vi-VN',
          en: 'en-US',
          es: 'es-ES',
          fr: 'fr-FR',
          de: 'de-DE',
          ja: 'ja-JP',
          zh: 'zh-CN',
          ko: 'ko-KR',
        };

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.rate = 0.9;
        utterance.pitch = 1;
        utterance.volume = 1;
        utterance.lang = voiceMap[language] || 'en-US';
        
        speechSynthesis.cancel();
        speechSynthesis.speak(utterance);
      }

      function detectLanguage(text) {
        // Vietnamese detection
        const vietnamesePattern = /[√†√°·∫°·∫£√£√¢·∫ß·∫•·∫≠·∫©·∫´ƒÉ·∫±·∫Ø·∫∑·∫≥·∫µ√®√©·∫π·∫ª·∫Ω√™·ªÅ·∫ø·ªá·ªÉ·ªÖ√¨√≠·ªã·ªâƒ©√≤√≥·ªç·ªè√µ√¥·ªì·ªë·ªô·ªï·ªó∆°·ªù·ªõ·ª£·ªü·ª°√π√∫·ª•·ªß≈©∆∞·ª´·ª©·ª±·ª≠·ªØ·ª≥√Ω·ªµ·ª∑·ªπƒë]/i;
        if (vietnamesePattern.test(text)) return 'vi';
        
        // Japanese detection (Hiragana, Katakana, Kanji)
        const japanesePattern = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/;
        if (japanesePattern.test(text)) return 'ja';
        
        // Korean detection (Hangul)
        const koreanPattern = /[\uAC00-\uD7AF\u1100-\u11FF\u3130-\u318F]/;
        if (koreanPattern.test(text)) return 'ko';
        
        // Chinese detection (CJK Unified Ideographs)
        const chinesePattern = /[\u4E00-\u9FFF]/;
        if (chinesePattern.test(text)) return 'zh';
        
        // Spanish detection
        const spanishWords = /\b(el|la|los|las|un|una|de|del|y|es|est√°|son|que|con|por|para|pero|como|muy|m√°s|todo|todos|tiene|hay|fue|hacer)\b/i;
        if (spanishWords.test(text)) return 'es';
        
        // French detection
        const frenchWords = /\b(le|la|les|un|une|de|du|des|et|est|sont|que|avec|pour|dans|ce|cette|tr√®s|plus|tout|tous|avoir|√™tre|faire)\b/i;
        const frenchAccents = /[√†√¢√§√©√®√™√´√Ø√Æ√¥√π√ª√º]/i;
        if (frenchWords.test(text) || frenchAccents.test(text)) return 'fr';
        
        // German detection
        const germanWords = /\b(der|die|das|den|dem|ein|eine|und|ist|sind|nicht|auch|von|zu|mit|auf|f√ºr|√ºber|bei|aber|oder|wenn|als|noch|nach|sehr|mehr)\b/i;
        const germanChars = /[√§√∂√º√ü]/i;
        if (germanWords.test(text) || germanChars.test(text)) return 'de';
        
        // Default to English
        return 'en';
      }

      function addToHistory(item) {
        historyData.unshift(item);
        if (historyData.length > 20) {
          historyData = historyData.slice(0, 20);
        }
        renderHistory();
      }

      function renderHistory() {
        const historyList = document.getElementById("historyList");
        
        if (historyData.length === 0) {
          historyList.innerHTML = '<div class="empty-history">No analysis history yet. Start analyzing!</div>';
          return;
        }

        const icons = {
          POSITIVE: "üòä",
          NEGATIVE: "üòû",
          NEUTRAL: "üòê",
          MIXED: "ü§î",
        };

        const languageNames = {
          en: "üá¨üáß EN",
          vi: "üáªüá≥ VI",
          es: "üá™üá∏ ES",
          fr: "üá´üá∑ FR",
          de: "üá©üá™ DE",
          ja: "üáØüáµ JA",
          zh: "üá®üá≥ ZH",
          ko: "üá∞üá∑ KO",
        };

        historyList.innerHTML = historyData.map((item, index) => {
          const date = new Date(item.timestamp);
          const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
          const maxScore = Math.max(item.score.Positive, item.score.Negative, item.score.Neutral, item.score.Mixed);
          const confidence = (maxScore * 100).toFixed(0);

          return `
            <div class="history-item" onclick="loadFromHistory(${index})">
              <div class="history-text">"${item.text}"</div>
              <div class="history-meta">
                <span>${icons[item.sentiment]} ${item.sentiment}</span>
                <span>${languageNames[item.language] || item.language}</span>
                <span>üìä ${confidence}%</span>
                <span>üïê ${timeStr}</span>
              </div>
            </div>
          `;
        }).join('');
      }

      function loadFromHistory(index) {
        const item = historyData[index];
        document.getElementById("comment").value = item.text;
        
        currentResult = {
          sentiment: item.sentiment,
          score: item.score,
          language: item.language,
          text: item.text
        };

        // Trigger display without re-analyzing
        const sentiment = item.sentiment;
        const score = item.score;
        const language = item.language;

        const icons = { POSITIVE: "üòä", NEGATIVE: "üòû", NEUTRAL: "üòê", MIXED: "ü§î" };
        const classes = { POSITIVE: "positive", NEGATIVE: "negative", NEUTRAL: "neutral", MIXED: "mixed" };
        const languageNames = {
          en: "English", vi: "Vietnamese", es: "Spanish", fr: "French",
          de: "German", ja: "Japanese", zh: "Chinese", ko: "Korean",
        };

        document.getElementById("resultBox").innerHTML = `
          <div class="language-info">
            üåç <strong>Language:</strong> ${languageNames[language] || language.toUpperCase()}
          </div>
          <div class="sentiment ${classes[sentiment]}">
            ${icons[sentiment]} ${sentiment}
          </div>
          <div class="score-details">
            <div class="score-bar">
              <div class="score-label positive">Positive</div>
              <div class="score-progress">
                <div class="score-fill" style="width: ${score.Positive * 100}%; background: #4caf50;"></div>
              </div>
              <div class="score-value">${(score.Positive * 100).toFixed(1)}%</div>
            </div>
            <div class="score-bar">
              <div class="score-label negative">Negative</div>
              <div class="score-progress">
                <div class="score-fill" style="width: ${score.Negative * 100}%; background: #ff0000;"></div>
              </div>
              <div class="score-value">${(score.Negative * 100).toFixed(1)}%</div>
            </div>
            <div class="score-bar">
              <div class="score-label neutral">Neutral</div>
              <div class="score-progress">
                <div class="score-fill" style="width: ${score.Neutral * 100}%; background: #ffeb3b;"></div>
              </div>
              <div class="score-value">${(score.Neutral * 100).toFixed(1)}%</div>
            </div>
            <div class="score-bar">
              <div class="score-label mixed">Mixed</div>
              <div class="score-progress">
                <div class="score-fill" style="width: ${score.Mixed * 100}%; background: #ff9800;"></div>
              </div>
              <div class="score-value">${(score.Mixed * 100).toFixed(1)}%</div>
            </div>
          </div>
        `;

        // Update chart
        const chartData = {
          labels: ["Positive", "Negative", "Neutral", "Mixed"],
          datasets: [{
            label: "Sentiment Score",
            data: [score.Positive * 100, score.Negative * 100, score.Neutral * 100, score.Mixed * 100],
            backgroundColor: ["#4caf50", "#ff0000", "#ffeb3b", "#ff9800"],
            hoverOffset: 8,
          }],
        };

        if (chartInstance) chartInstance.destroy();

        const ctx = document.getElementById("sentimentChart").getContext("2d");
        chartInstance = new Chart(ctx, {
          type: "doughnut",
          data: chartData,
          options: {
            plugins: {
              legend: { position: "bottom", labels: { color: "#444" } },
            },
          },
        });

        document.getElementById("speakBtn").disabled = false;
      }

      function clearHistory() {
        if (confirm("Are you sure you want to clear all history?")) {
          historyData = [];
          renderHistory();
        }
      }
    </script>
  </body>
</html>